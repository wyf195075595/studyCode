<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>开始使用layui</title>
  <link rel="stylesheet" href="./layui/css/layui.css">
  <link rel="stylesheet" href="./css/index.css">
</head>
<style>
  .box1{
    width: 400px;
    height: 400px;
    border: 1px solid red;
    box-sizing: border-box;
    display: table;
    text-align: center;
  }
  .inner{
    display: table-cell;
    vertical-align: middle;
  }
  #dataTable{
    width: 600px;
    height: 400px;
  }
</style>
<body>

<!-- 你的HTML代码 -->
<div class = "box1">
  <div class="inner">123</div>
</div>
<div id="tree"></div>
<div id="dataTable"></div>
<script src="./layui/layui.js"></script>
<script src="./js/jquery-1.7.1.min.js"></script>
<script>
  (function (doc, win) {
      var scaleNum = 1;
      var docEl = doc.documentElement,
          resizeEvt = "orientationchange" in window ? "orientationchange" : "resize",
          recalc = function () {
              var width = docEl.clientWidth / 19.20;
              docEl.style.fontSize = width + "px";
              scaleNum = width;
          };
      if (!doc.addEventListener) return;
      win.addEventListener(resizeEvt, recalc, false);
      doc.addEventListener("DOMContentLoaded", recalc, false);
  })(document, window);
  layui.config({
      base:'layui/layui_extends/',
    }).extend({
        treeTable:'treeTable/treeTable/'
    })
  layui.use(['tree','treetable'], function(){

    var tree = layui.tree;
    var treetable = layui.treetable;
    // area:{
    //       id: "9c232a0936434c9b8ac9f8fafa78d962",
    //       isNewRecord: false,
    //       name: "湖南检修公司",
    //       parentIds: "0,"
    //     },
    var datas = {
    code: 200,
    count: null,
    data: null,
    data1: null,
    data2: null,
    msg: "success",
    rows: [
      {
        id: "95624674-79f6-4c12-9e57-a9716be6d30e",
        isNewRecord: false,
        master: null,
        name: "变电检修一班",
        parentCode: null,
        parentId: "32b1953a-9d6f-490b-a59a-f0fa4fa8602d",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,32b1953a-9d6f-490b-a59a-f0fa4fa8602d,"
      },
      {
        id: "5e1c3c91-0bce-4545-b74c-f83de8ef1a40",
        isNewRecord: false,
        master: null,
        name: "公司领导",
        parentCode: null,
        parentId: "2182ad03-8601-42db-bc32-3f28918affae",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,2182ad03-8601-42db-bc32-3f28918affae,"
      },
      {
        id: "2c4db7f7-4c4b-4a4f-b952-56bc8ee0c5a8",
        isNewRecord: false,
        master: null,
        name: "检修班",
        parentCode: null,
        parentId: "ee3dcfd8-8517-44d9-9296-d66283b11164",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,ee3dcfd8-8517-44d9-9296-d66283b11164,"
      },
      {
        id: "ef012f96-0ea2-467f-a185-e1b915586e86",
        isNewRecord: false,
        master: null,
        name: "辅助用工班",
        parentCode: null,
        parentId: "7e7355b3-2f5f-48b7-96d1-0ed326a143d7",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,7e7355b3-2f5f-48b7-96d1-0ed326a143d7,"
      },
      {
        id: "cd6d85b0-241d-4cc4-a058-a9c2c8aced26",
        isNewRecord: false,
        master: null,
        name: "辅助用工班",
        parentCode: null,
        parentId: "c6cdcf11-b04b-474e-a45c-f6cd9287c4ba",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,c6cdcf11-b04b-474e-a45c-f6cd9287c4ba,"
      },
      {
        id: "d0e9bb57-7d90-4126-b3eb-89ba4dd558b8",
        isNewRecord: false,
        master: null,
        name: "财务资产部",
        parentCode: null,
        parentId: "18f923a7-5a5e-426d-94ae-a55ad1a4b240",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,"
      },
      {
        id: "3133675a-c826-49d5-8ba7-81677fabb4cc",
        isNewRecord: false,
        master: null,
        name: "管控班",
        parentCode: null,
        parentId: "34d8bb7d-e152-46ff-9a7c-5fb7761fe0da",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,34d8bb7d-e152-46ff-9a7c-5fb7761fe0da,"
      },
      {
        id: "a9f0c509-ebbc-40d7-b6e7-aef05105358b",
        isNewRecord: false,
        master: null,
        name: "长沙运维分部",
        parentCode: null,
        parentId: "18f923a7-5a5e-426d-94ae-a55ad1a4b240",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,"
      },
      {
        id: "febb4338-52ea-4ff6-b4b0-70557200d156",
        isNewRecord: false,
        master: null,
        name: "变电检修一班",
        parentCode: null,
        parentId: "a9f0c509-ebbc-40d7-b6e7-aef05105358b",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,a9f0c509-ebbc-40d7-b6e7-aef05105358b,"
      },
      {
        id: "8c7217d1-4d42-4c89-8111-194694666fa1",
        isNewRecord: false,
        master: null,
        name: "二次检修一班",
        parentCode: null,
        parentId: "2d2b5956-bac1-4d56-b3c5-c0116df672eb",
        parentIds: "0,18f923a7-5a5e-426d-94ae-a55ad1a4b240,2d2b5956-bac1-4d56-b3c5-c0116df672eb,"
      },
    ],
      total: 6
    }

    var dataTable = treeTable.render({
        elem: '#dataTable',
        tree: {
            iconIndex: 1,
            idName: 'id',
            openName: 'name',
            getIcon: function (d) {
                if (d.children.length == 0) {
                    return '';
                } else {
                    return '';
                }
            }
        },
        cols: [
            {type: 'numbers'},
            {title: '机构名称', align: 'center', field: 'name'},
            {
                title: '归属区域', align: 'center', field: 'area', templet: function (d) {
                    return d.area.name
                }
            },
            {title: '机构编码', align: 'center', field: 'code'},
            {title: '机构类型', align: 'center', field: 'typeName'},
            {title: '备注', align: 'center', field: 'remarks'},
            {title: '操作', fixed: 'right', toolbar: '#dataTable-toolbar'},
        ],
        reqData: function (data, callback) {
            var param = form.val('query-form')
              var treeData = initTree(datas.rows, 'id', 'parentId', null)
              callback(treeData);
        },
        text: {
            none: '暂无数据'
        },
        done: function () {
            initButton()
        }
    });
    //渲染
    var inst1 = tree.render({
      elem: '#tree'  //绑定元素
      ,edit:true
      ,accordion:true
      ,id:'demoId'
      ,data: [{
        title: '江西' //一级菜单
        ,children: [{
          title: '南昌' //二级菜单
          ,children: [{
            title: '高新区' //三级菜单
            //…… //以此类推，可无限层级
          }]
        }]
      },{
        title: '陕西' //一级菜单
        ,children: [{
          title: '西安' //二级菜单
        }]
      }]
      ,click: function(obj){
        console.log(obj.data); //得到当前点击的节点数据
        console.log(obj.state); //得到当前节点的展开状态：open、close、normal
        console.log(obj.elem); //得到当前节点元素
        console.log($(obj.elem).text());
        
        console.log(obj.data.children); //当前节点下是否有子节点
      }
      ,oncheck: function(obj){//复选框监听
        console.log(obj.data); //得到当前点击的节点数据
        console.log(obj.checked); //得到当前节点的展开状态：open、close、normal
        console.log(obj.elem); //得到当前节点元素
      },
      operate: function(obj){
        var type = obj.type; //得到操作类型：add、edit、del
        var data = obj.data; //得到当前节点的数据
        var elem = obj.elem; //得到当前节点元素
        
        //Ajax 操作
        var id = data.id; //得到节点索引
        if(type === 'add'){ //增加节点
          //返回 key 值
          return 123;
        } else if(type === 'update'){ //修改节点
          console.log(elem.find('.layui-tree-txt').html()); //得到修改后的内容
        } else if(type === 'del'){ //删除节点
          
        };
      }
    });
    var checkData = tree.getChecked('demoId');
  });

//一般直接写在一个js文件中
// layui.use(['layer', 'form'], function(){
//   var layer = layui.layer
//   ,form = layui.form;

  // layer.msg('Hello World');
  // var device = layui.device();
  // console.log(device)
  // var device = layui.device('myapp');
  //   if(device.myapp){
  //     alert('在我的App环境');
  //   }
// });
$(function(){
  initTT()
  function initTT(){
    const head = new Promise((resolve,reject)=>{
    var data =  [
        {
          fault_time: "2020-05-14 15:26:31.571",//--故障时间
          key_id: "6a4546a0bb624e558741215325112c56",
          primary_dev: "500千伏九石二线",//--故障元件
          fault_dis: "117.10",//--故障测距
          fault_phase: "B相接地"//--故障相别
        }
      ]
    resolve(data[0])
  })
    head.then(data1=>{
      const bodyleft = new Promise((resolve,reject)=>{
      var data =  [
          {
            station_name: "九龙",//--厂站
            name: "500千伏九石二线2号线路保护装置RCS931EG"//--设备名称
          },
          {
            station_name: "八龙",//--厂站
            name: "500千伏九石二线2号线路保护装置RCS931EG"//--设备名称
          },
          {
            station_name: "八龙",//--厂站
            name: "500千伏3号故障录波器ZH-3"//--设备名称
          },
          {
            station_name: "石棉",
            name: "500千伏3号故障录波器ZH-3"
          },
          {
            station_name: "石棉",
            name: "主变2号故障录波器ZH-2B"
          },
          {
            station_name: "石棉",
            name: "500千伏2号故障录波器ZH-3"
          }
        ];
      var station =[]
      var resData = [
          // {
          //   cz:'',
          //   sbmc:[]
          // }
        ]
      data.map((item,index)=>{
          if(!station.includes(item.station_name)){
            resData.push({
              cz:item.station_name,
              sbmc:[item.name]
            })
            station.push(item.station_name)
          }else{
            resData.map((items,index)=>{
              if(items.cz == item.station_name){
                items.sbmc.push(item.name)
              }
            })
          }
        })
      console.log('resData',resData,station );
        
      resolve(resData)
    })

      const bodyright = new Promise((resolve,reject)=>{
      var data =  [
            {
              trip_name: "B相跟跳",//--动作概况（1.故障位置）
              name: "500千伏九石二线2号线路保护装置RCS931EG",//--设备名称
              trip_value: "1",//--动作概况（2）
              dzmx:'',//--动作描述
              wave_file_name:''//录波文件
            },
            {
              trip_name: "B相重合1",
              name: "500千伏3号故障录波器ZH-3",
              trip_value: "0"
            },
            {
              trip_name: "B相重合1",
              name: "500千伏3号故障录波器ZH-3",
              trip_value: "0"
            },
            {
              trip_name: "工频变化量阻抗",
              name: "500千伏2号故障录波器ZH-3",
              trip_value: "1",
              wave_file_name: "d__data_0K5EF261",
              dzmx: "0ms 最大零序电流"
            },
            {
              trip_name: "工频变化量阻抗1",
              name: "500千伏2号故障录波器ZH-3",
              trip_value: "1",
              wave_file_name: "d__data_0K5EF261",
              dzmx: "0ms 最大零序电流"
            }
        ];
      var station = [];
      var resData = [
          // {
          //   sbmc:'',
          //   data:[]
          // }
        ]
      data.map((item,index)=>{
          if(!station.includes(item.name)){
            resData.push({
              sbmc:item.name,
              data:[item]
            })
            station.push(item.name)
          }else{
            resData.map((items,index)=>{
              if(items.sbmc == item.name){
                items.data.push(item)
              }
            })
          }
        })
        
      resolve(resData)
    })
      
      Promise.all([bodyleft,bodyright]).then((res)=>{
          BBTC({head:data1,bodyleft:res[0],bodyright:res[1]})
      })

    })

    
  }

  // znjc()
  // znjc1()
  function todownload(name,path){
      console.log(name,'----',path);
      // location.href=`${index_baseUrl1}/jydwDevice/bx-fault-report-all-info/e?name=${name}&path=${path}&token=${token}`;
  }
  function znjc(){
    var title = '智能决策'
    data = {
      bdz : '变电站',
      jgxx : '警告类型',
      yw : '运维',
      jxyczy : '一次专业',
      jxeczy : '二次专业',
      endTime:'2020-1-1'
    }
    layui.use(['table','layer'], function(){
              var table = layui.table;
              var layer = layui.layer;
              var content = `
              <div id="jc-box">
                <table>
                  <tr>
                    <td colspan = '2'>变电站</td>  
                    <td colspan = '2'>${data.bdz}</td>  
                    <td>备注</td>  
                  </tr>
                  <tr>
                    <td colspan = '2'>异常信息描述</td>  
                    <td colspan = '2'>${data.jgxx}</td>
                    <td rowspan = '5' class="detailbg"><div class="content">备注。。。</div></td>
                  </tr>
                  <tr>
                    <td colspan = '2'>截至时间</td>  
                    <td colspan = '2'>${data.endTime}</td>  
                  </tr>
                  <tr>
                    <td rowspan = '3' class="zong"><div>智能决策</div></td>  
                    <td class="zong" ><div>运维专业决策建议</div></td>  
                    <td colspan = '2'><div class="content"><p>${data.yw}</p></div></td>    
                  </tr>
                  <tr>
                    <td class="zong" rowspan = '2'><div>检修专业决策建议</div></td>  
                    <td  class="zong"><div>一次专业</div></td>  
                    <td ><div class="content"><p>${data.jxyczy}</p></div></td>  
                  </tr>
                  <tr>
                    <td class="zong"><div>二次专业</div></td>  
                    <td ><div class="content"><p>${data.jxeczy}</p></div></td>  
                  </tr>
                </table>
              </div>
              `
              detailBoxNoBtn(title,  `<div id="jcContainer">${content}</div>`,
                            function(index, layero){
                              $('#jcContainer').height($(".layui-layer-content")[0].style.height)
                            },
                            function(index, layero){
                            },8.5,5.5,"my-skin");//12,6.5
          });
  }

  function znjc1(){
    var title = '智能决策'
    data = {
      bdz : '变电站',
      jgxx : '警告类型',
      yw : '运维',
      jxyczy : '一次专业',
      jxeczy : '二次专业',
    }
    layui.use(['table','layer'], function(){
              var table = layui.table;
              var layer = layui.layer;
              var content = `
              <div id="jc-box">
                  <div>
                      <div>变电站</div>
                      <div>异常信息描述</div>
                      <div>
                          <div><p>智能决策</p></div>
                          <div>
                              <div><p>运维专业决策建议</p></div>
                              <div><p>检修专业决策建议</p></div>
                          </div>
                      </div>
                  </div>
                  <div>
                      <div>${data.bdz}</div>
                      <div>${data.jgxx}</div>
                      <div>${data.yw}</div>
                      <div>
                          <div><p>一次专业</p></div>
                          <div>${data.jxyczy}</div>
                      </div>
                      <div>
                          <div><p>二次专业</p></div>
                          <div>${data.jxeczy}</div>
                      </div>
                  </div>
                  <div>
                      <div>备注</div>
                      <div>${data.endTime}</div>
                  </div>
              </div>
              `
              detailBoxNoBtn(title,  `<div id="jcContainer">${content}</div>`,
                            function(index, layero){
                              $('#jcContainer').height($(".layui-layer-content")[0].style.height)
                            },
                            function(index, layero){
                            },8.5,5.5,"my-skin");//12,6.5
          });
  }

  function BBTC(data){
    console.log('数据：',data);

    var trs = '',bodyright = data.bodyright;
    //厂站rowspan数  
    function czRowspan(data){
        var sum = 0;
        data.map((item,index)=>{
          bodyright.map((items,index)=>{
            if(items.sbmc == item){
              sum += items.data.length + 2
            }
          })
        })
        console.log('厂站rowspan数',sum);
        return sum ;
    }
    //设备名称rowspan数  
    function sbmcRowspan(sbmc){
      var sum = 0;
        bodyright.map((items,index)=>{
          if(items.sbmc == sbmc){
            sum += items.data.length + 2
          }
        })
        console.log('设备名称rowspan数  ',sum);
      return sum ;
    }
    //某设备名称下的动作和录波
    function targetArr(sbmc){
      var data = []
        bodyright.map((item1,index)=>{
          if(item1.sbmc == sbmc){
            data = item1.data
          }
        })
        return data
    }
        
    data.bodyleft.map((item,index1)=>{ //厂站
      item.sbmc.map((items,index2)=>{//设备名称
        var sbLen = targetArr(items).length
            targetArr(items).map((data,i)=>{
              
                if(i == 0){
                    if(targetArr(items).length >1){
                      trs += `<tr>
                              ${index2==0?`<td rowspan='${czRowspan(item.sbmc)}'>${item.cz}</td>`:''}
                              ${i==0?`<td rowspan='${sbmcRowspan(items)}'>${items}</td>`:''}
                              <td>故障位置</td>
                              <td>25.03356KM</td>
                              <td>0ms保护启动动作</td>
                              <td>2020-07-23</td>
                              <td>PL1下载</td>
                          </tr>
                          <tr>
                              <td>${data.trip_name}</td>
                              <td>${data.trip_value}</td>
                              <td>动作描述</td>
                              <td></td>
                              <td><span onclick="todownload('${data.trip_name}','${data.trip_value}')">下载</span></td>
                          </tr>`
                    }else{
                      trs += `<tr>
                              ${index2==0?`<td rowspan='${czRowspan(item.sbmc)}'>${item.cz}</td>`:''}
                              ${i==0?`<td rowspan='${sbmcRowspan(items)}'>${items}</td>`:''}
                              <td>故障位置</td>
                              <td>25.03356KM</td>
                              <td>0ms保护启动动作</td>
                              <td>2020-07-23</td>
                              <td>PL1下载</td>
                          </tr>
                          <tr>
                              <td>${data.trip_name}</td>
                              <td>${data.trip_value}</td>
                              <td>动作描述</td>
                              <td></td>
                              <td></td>
                          </tr>
                          <tr style="color:red;">
                              <td>动作时间</td>
                              <td>2020-05-14 15:26:31.571</td>
                              <td></td>
                              <td></td>
                              <td></td>
                          </tr>`
                    }
                    
                  }else {
                      console.log('i',i);
                      if(i == targetArr(items).length - 1){
                        trs += `<tr>
                          <td>${data.trip_name}</td>
                          <td>${data.trip_value}</td>
                          <td>动作描述</td>
                          <td></td>
                          <td></td>
                      </tr>
                      <tr style="color:red;">
                          <td>动作时间</td>
                          <td>2020-05-14 15:26:31.571</td>
                          <td></td>
                          <td></td>
                          <td></td>
                      </tr>
                      `
                      }else{
                        trs += `<tr>
                          <td>${data.trip_name}</td>
                          <td>${data.trip_value}</td>
                          <td>动作描述</td>
                          <td></td>
                          <td></td>
                      </tr>`
                      }
                      
                    
                  }
            })
                  
            })
      })

    layui.use(['table','layer'], function(){
              var table = layui.table;
              var layer = layui.layer;
                  detailBoxNoBtn("故障报告",`<div id="bbBox">
                    <div class="tableTools">
                      <div class="downLoad"><i class="layui-icon layui-icon-download-circle"></i>  </div>
                      </div>
                      <table>
                          <thead>
                              <tr class="firstLine">
                                  <td >故障原件</td>
                                  <td class="bg-gzyj">${data.head.primary_dev}</td>
                                  <td rowspan='2' colspan='3'>故障类别:${data.head.fault_phase}</td>
                                  <td rowspan='2' >故障测距</td>
                                  <td rowspan='2'>${data.head.fault_dis}</td>
                              </tr>
                              <tr>
                                  <td>故障时间</td>
                                  <td class="bg-gzsj">${data.head.fault_time}</td>
                              </tr>
                              <tr>
                                  <td>厂站</td>
                                  <td>设备名称</td>
                                  <td colspan='2'>动作概况</td>
                                  <td>动作描述</td>
                                  <td colspan='2'>录波文件</td>
                              </tr>
                          </thead>
                          <tbody>
                              ${trs}
                          </tbody>
                      </table>    
                  </div>`,
                            function(index, layero){
                                /*背景虚化*/
                              //   $("header").css("filter","blur(4px)");
                              //   $("footer").css("filter","blur(4px)");
                              //   $(".index-main").css("filter","blur(4px)");
                            },
                            function(index, layero){
                            },16,8,"my-skin");
            });
  }

  function detailBoxNoBtn(title, content, successcallback, surecallback, width, height, skinclass, btn2callback, endcallback) {
      var w = (width == null || width == undefined) ? 9.5 : width;
      var h = (height == null || height == undefined) ? 6.5 : height;
      layer.open({
          type: 1
          , title: title
          , area: [w + 'rem', h + 'rem'] //大小
          , content: content
          , shade: 0.3 //显示遮罩
          , resize: false
          // , move: false
          , skin: skinclass
          , success: function (layero, index) {
              if (typeof successcallback === "function") {
                  successcallback(index, layero);
              }
          }
          , yes: function (index, layero) {
              if (typeof surecallback === "function") {
                  surecallback(index, layero);
              }
          }
          , btn2: function (index, layero) {
              //按钮【取消】的回调
              if (typeof btn2callback === "function") {
                  btn2callback(index, layero);
              }
              layer.close(index);
          }
          , cancel: function () {
              //右上角关闭回调
          }
          , end: function () {
              $("header").removeAttr("style");
              $("footer").removeAttr("style");
              $(".index-main").removeAttr("style");

              if (typeof endcallback === "function") {
                  endcallback();
              }
          }
      });
  }

})

</script>
</body>
</html>